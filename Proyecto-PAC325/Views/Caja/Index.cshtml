@model List<Proyecto_PAC325.Models.CajaModel>
@{
    ViewData["Title"] = "Cajas";
    var idComercio = ViewBag.IdComercio as int? ?? 0;
}
@if (TempData["error"] != null)
{
    <div class="mensaje error" id="mensaje">
        <span>@TempData["error"]</span>
        <button id="cerrar-modal">×</button>
    </div>
}
else if (TempData["success"] != null)
{
    <div class="mensaje success" id="mensaje">
        <span>@TempData["success"]</span>
        <button id="cerrar-modal">×</button>
    </div>
}
<section class="bienvenida">
    <div>
        <p>Apartado de Cajas</p>
        <h1>ESTE ES EL APARTADO DE CAJAS</h1>
        <p>Las cajas listadas representan los teléfonos asociados a cada comercio para recibir SINPE.</p>
    </div>
</section>

<div class="titulo-container"><h2>CAJAS DEL COMERCIO</h2></div>

<div class="act-container">
    <h3>Acciones: </h3>
    <a class="activo" asp-action="Index" asp-route-idComercio="@idComercio">Lista</a>
    <a asp-action="Registro" asp-route-idComercio="@idComercio">Registrar</a>
</div>

<section class="vista-tabla">
    <section class="tabla-container">
        <table class="tabla">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Teléfono SINPE</th>
                    <th>Fecha de registro</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model == null || !Model.Any())
                {
                    <tr>
                        <td colspan="6" style="text-align:center; padding:2rem;">
                            No hay cajas para mostrar.
                            @if (idComercio == 0)
                            {
                                <div>(No se recibió idComercio.)</div>
                            }
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var c in Model)
                    {
                        <tr>
                            <td>@c.Nombre</td>
                            <td>@(string.IsNullOrEmpty(c.Descripcion) ? "" : (c.Descripcion.Length > 30 ? c.Descripcion.Substring(0, 30) + "…" : c.Descripcion))</td>
                            <td>@(string.IsNullOrWhiteSpace(c.TelefonoSINPE) ? "-" : c.TelefonoSINPE)</td>
                            <td>@c.FechaDeRegistro.ToString("g")</td>
                            <td>@(c.Estado == 1 ? "Activo" : "Inactivo")</td>
                            <td>
                                <a class="boton bg-success" asp-action="Editar" asp-route-idCaja="@c.IdCaja">Editar</a>
                                <button type="button" class="boton bg-oscuro" onclick="openSinpeModal('@(c.TelefonoSINPE ?? "")')">Ver SINPE</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </section>
</section>

<!-- Modal -->
<div class="modal fade" id="sinpeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transacciones SINPE</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="sinpeModalBody">
                <div class="text-center p-3">Cargando...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="boton bg-oscuro" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function openSinpeModal(telefono) {
          const body = document.getElementById('sinpeModalBody');
          body.innerHTML = '<div class="text-center p-3">Cargando...</div>';

          if (!telefono) {
            body.innerHTML = '<div class="p-3 text-warning">Caja sin teléfono SINPE.</div>';
            new bootstrap.Modal(document.getElementById('sinpeModal')).show();
            return;
          }

          const url = `/Caja/VerSinpe?telefono=${encodeURIComponent(telefono)}`;
          try {
            const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!resp.ok) {
              body.innerHTML = '<div class="p-3 text-danger">No se pudieron cargar las transacciones.</div>';
            } else {
              body.innerHTML = await resp.text();
            }
            new bootstrap.Modal(document.getElementById('sinpeModal')).show();
          } catch (ex) {
            body.innerHTML = '<div class="p-3 text-danger">Error de red al cargar las transacciones.</div>';
            console.error(ex);
            new bootstrap.Modal(document.getElementById('sinpeModal')).show();
          }
        }
    </script>
}